
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®šä½è³‡è¨Šé€å‡º</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      margin: 0;
      background-color: #f9f9f9;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 2em;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h3 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 1em;
    }
    select, button {
      width: 100%;
      padding: 0.75em;
      margin-top: 0.5em;
      font-size: 1em;
    }
    #status {
      margin-top: 1em;
      color: #333;
      min-height: 2em;
    }
    #spinner {
      display: none;
      margin: 1em auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .map-link {
      margin-top: 1em;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h3>å®šä½è³‡è¨Šé€å‡º</h3>

    <label for="companySelect">æ¨™åˆ¥ï¼š</label>
    <select id="companySelect">
      <option value="">è«‹é¸æ“‡æ¨™åˆ¥</option>
      <option value="companyA">é»ƒç·šYC01æ¨™</option>
      <option value="companyB">é»ƒç·šYC02æ¨™</option>
      <option value="companyC">é»ƒç·šYC03æ¨™</option>
      <option value="companyD">é»ƒç·šYM01æ¨™</option>
    </select>

    <label for="emailSelect">Emailï¼š</label>
    <select id="emailSelect">
      <option value="">è«‹å…ˆé¸æ“‡æ¨™åˆ¥</option>
    </select>

    <label for="action">å‹•ä½œï¼š</label>
    <select id="action">
      <option value="checkin">ç°½åˆ°</option>
      <option value="checkout">ç°½é€€</option>
    </select>

    <button id="submitBtn" onclick="submitLocation()">é€å‡ºå®šä½è³‡è¨Š</button>
    <div id="spinner"></div>
    <div id="status">å°šæœªé€å‡º</div>
    <div class="map-link" id="mapLink"></div>
  </div>

  <script>
    const statusDiv = document.getElementById("status");
    const companySelect = document.getElementById("companySelect");
    const emailSelect = document.getElementById("emailSelect");
    const spinner = document.getElementById("spinner");
    const mapLink = document.getElementById("mapLink");

    function getWebAppUrl(company) {
      const urlMap = {
        companyA: "https://script.google.com/macros/s/AKfycbyu3uQ_mvoOCAlWCGMSeEy_BGN8fpSym-PCrOl3xpzGAvZpa_qDGNxs4LZoB8HBC7bkRA/exec",
        companyB: "https://script.google.com/macros/s/AKfycbwA2UXLFMlle8QyKa1C3VAeyW6yxivm-4CraFBnf6mm4cs_BDITLnWVnLG3gCinQjEP/exec",
        companyC: "https://script.google.com/macros/s/AKfycby0NZ_V2vnDgYMYAyWGMwOlWoWQAuH_YOn8EfycIp-RC6JSg9-iIz3xjkZpOPU1RpZd/exec",
        companyD: "https://script.google.com/macros/s/AKfycbxeMVCtaXAFpM1laStaDdG9It985yzDvJXC02drFUrUUumPc8eiVf-oELCbT1nNjijDNw/exec"
      };
      return urlMap[company];
    }

    companySelect.addEventListener("change", function () {
      const company = companySelect.value;
      const webAppUrl = getWebAppUrl(company);
      if (!webAppUrl) {
        emailSelect.innerHTML = "<option value=''>è«‹å…ˆé¸æ“‡æ¨™åˆ¥</option>";
        return;
      }

      const emailListUrl = `${webAppUrl}?company=${company}`;
      emailSelect.innerHTML = "<option value=''>è¼‰å…¥ä¸­...</option>";
      fetch(emailListUrl)
        .then(response => response.json())
        .then(emailList => {
          emailSelect.innerHTML = "<option value=''>è«‹é¸æ“‡ Email</option>";
          emailList.forEach(email => {
            const option = document.createElement("option");
            option.value = email;
            option.textContent = email;
            emailSelect.appendChild(option);
          });
          statusDiv.textContent = "âœ… Email æ¸…å–®è¼‰å…¥å®Œæˆ";
        })
        .catch(error => {
          console.error("è¼‰å…¥ Email æ¸…å–®å¤±æ•—", error);
          statusDiv.textContent = "âŒ è¼‰å…¥ Email æ¸…å–®å¤±æ•—";
        });
    });

    function getTodayKey(email) {
      const today = new Date().toISOString().slice(0, 10);
      return `${email}_${today}`;
    }

    function submitLocation() {
      const company = companySelect.value;
      const webAppUrl = getWebAppUrl(company);
      const email = emailSelect.value.trim();
      const action = document.getElementById("action").value;
      const button = document.getElementById("submitBtn");
      mapLink.innerHTML = "";

      if (!company || !webAppUrl) {
        statusDiv.textContent = "è«‹å…ˆé¸æ“‡å…¬å¸ã€‚";
        return;
      }

      if (!email) {
        statusDiv.textContent = "è«‹å…ˆé¸æ“‡ Emailã€‚";
        return;
      }

      const todayKey = getTodayKey(email);
      if (action === "checkin" && localStorage.getItem(todayKey)) {
        statusDiv.textContent = "âš ï¸ ä»Šæ—¥å·²ç°½åˆ°éï¼Œè«‹å‹¿é‡è¤‡ç°½åˆ°ã€‚";
        return;
      }

      button.disabled = true;
      spinner.style.display = "block";
      statusDiv.textContent = "æ­£åœ¨å–å¾—å®šä½è³‡è¨Š...";

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            mapLink.innerHTML = `<a href='https://www.google.com/maps?q=${lat},${lng}' target='_blank'>ğŸ“ æŸ¥çœ‹åœ°åœ–</a>`;
            statusDiv.textContent = `å–å¾—åº§æ¨™ï¼š(${lat}, ${lng})ï¼Œæ­£åœ¨é€å‡º...`;

            fetch(webAppUrl, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ company, email, action, lat, lng })
            })
            .then(response => response.text())
            .then(data => {
              statusDiv.textContent = `ä¼ºæœå™¨å›æ‡‰ï¼š${data}`;
              if (action === "checkin" && data.includes("âœ… ç°½åˆ°æˆåŠŸ")) {
                localStorage.setItem(todayKey, "checked");
              } else if (action === "checkout" && data.includes("âœ… ç°½é€€æˆåŠŸ")) {
                localStorage.removeItem(todayKey);
              }
              button.disabled = false;
              spinner.style.display = "none";
            })
            .catch(error => {
              statusDiv.textContent = `é€å‡ºå¤±æ•—ï¼š${error}`;
              button.disabled = false;
              spinner.style.display = "none";
            });
          },
          error => {
            statusDiv.textContent = "âŒ å®šä½å¤±æ•—ï¼Œè«‹é–‹å•Ÿ GPS ä¸¦å…è¨±å®šä½æ¬Šé™ã€‚";
            button.disabled = false;
            spinner.style.display = "none";
          }
        );
      } else {
        statusDiv.textContent = "æ‚¨çš„è£ç½®ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚";
        button.disabled = false;
        spinner.style.display = "none";
      }
    }
  </script>
</body>
</html>
