<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>定位資訊送出</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    #status { margin-top: 1em; color: green; }
    input, select { margin: 0.5em 0; padding: 0.5em; width: 100%; max-width: 300px; }
    button { padding: 0.5em 1em; }
  </style>
</head>
<body>
  <h2>定位資訊送出測試</h2>
  <p>請輸入您的 Email 並選擇動作，系統將自動送出定位資訊。</p>
  <input type="email" id="email" placeholder="請輸入您的 Email" required>
  <select id="action">
    <option value="checkin">簽到</option>
    <option value="checkout">簽退</option>
  </select>
  <button id="submitBtn" onclick="submitLocation()">送出定位資訊</button>
  <div id="status">尚未送出</div>

  <script>
    const statusDiv = document.getElementById("status");
    const webAppUrl = "https://script.google.com/macros/s/AKfycbxjesp01YxoG9SCnqpD78AUNjVzPy39kUpYiujbgLitNjb1RcDBvly-2hNL5ekuzF94/exec";

    function getTodayKey(email) {
      const today = new Date().toISOString().slice(0, 10); // yyyy-mm-dd
      return `${email}_${today}`;
    }

    function submitLocation() {
      const email = document.getElementById("email").value.trim();
      const action = document.getElementById("action").value;
      const button = document.getElementById("submitBtn");

      if (!email) {
        statusDiv.textContent = "請先輸入 Email。";
        return;
      }

      const todayKey = getTodayKey(email);

      if (action === "checkin" && localStorage.getItem(todayKey)) {
        statusDiv.textContent = "⚠️ 今日已簽到過，請勿重複簽到。";
        return;
      }

      button.disabled = true;
      statusDiv.textContent = "正在取得定位資訊...";

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            statusDiv.textContent = `取得座標：(${lat}, ${lng})，Email：${email}，動作：${action}，正在送出...`;

            fetch(webAppUrl, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ email, action, lat, lng })
            })
            .then(response => response.text())
            .then(data => {
              statusDiv.textContent = `伺服器回應：${data}`;
              if (action === "checkin" && data.includes("✅ 簽到成功")) {
                localStorage.setItem(todayKey, "checked");
              } else if (action === "checkout" && data.includes("✅ 簽退成功")) {
                localStorage.removeItem(todayKey); // 可選：簽退後清除簽到狀態
              }
              button.disabled = false;
            })
            .catch(error => {
              statusDiv.textContent = `送出失敗：${error}`;
              button.disabled = false;
            });
          },
          error => {
            statusDiv.textContent = "無法取得定位：" + error.message;
            button.disabled = false;
          }
        );
      } else {
        statusDiv.textContent = "您的裝置不支援定位功能。";
        button.disabled = false;
      }
    }
  </script>
</body>
</html>
