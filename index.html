
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>定位資訊送出</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      margin: 0;
      background-color: #f9f9f9;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 2em;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h3 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 1em;
    }
    select, button {
      width: 100%;
      padding: 0.75em;
      margin-top: 0.5em;
      font-size: 1em;
    }
    #status {
      margin-top: 1em;
      color: #333;
      min-height: 2em;
    }
    #spinner {
      display: none;
      margin: 1em auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .map-link {
      margin-top: 1em;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h3>定位資訊送出</h3>

    <label for="companySelect">標別：</label>
    <select id="companySelect">
      <option value="">請選擇標別</option>
      <option value="companyA">黃線YC01標</option>
      <option value="companyB">黃線YC02標</option>
      <option value="companyC">黃線YC03標</option>
      <option value="companyD">黃線YM01標</option>
    </select>

    <label for="emailSelect">Email：</label>
    <select id="emailSelect">
      <option value="">請先選擇標別</option>
    </select>

    <label for="action">動作：</label>
    <select id="action">
      <option value="checkin">簽到</option>
      <option value="checkout">簽退</option>
    </select>

    <button id="submitBtn" onclick="submitLocation()">送出定位資訊</button>
    <div id="spinner"></div>
    <div id="status">尚未送出</div>
    <div class="map-link" id="mapLink"></div>
  </div>

  <script>
    const statusDiv = document.getElementById("status");
    const companySelect = document.getElementById("companySelect");
    const emailSelect = document.getElementById("emailSelect");
    const spinner = document.getElementById("spinner");
    const mapLink = document.getElementById("mapLink");

    function getWebAppUrl(company) {
      const urlMap = {
        companyA: "https://script.google.com/macros/s/AKfycbyu3uQ_mvoOCAlWCGMSeEy_BGN8fpSym-PCrOl3xpzGAvZpa_qDGNxs4LZoB8HBC7bkRA/exec",
        companyB: "https://script.google.com/macros/s/AKfycbwA2UXLFMlle8QyKa1C3VAeyW6yxivm-4CraFBnf6mm4cs_BDITLnWVnLG3gCinQjEP/exec",
        companyC: "https://script.google.com/macros/s/AKfycby0NZ_V2vnDgYMYAyWGMwOlWoWQAuH_YOn8EfycIp-RC6JSg9-iIz3xjkZpOPU1RpZd/exec",
        companyD: "https://script.google.com/macros/s/AKfycbxeMVCtaXAFpM1laStaDdG9It985yzDvJXC02drFUrUUumPc8eiVf-oELCbT1nNjijDNw/exec"
      };
      return urlMap[company];
    }

    companySelect.addEventListener("change", function () {
      const company = companySelect.value;
      const webAppUrl = getWebAppUrl(company);
      if (!webAppUrl) {
        emailSelect.innerHTML = "<option value=''>請先選擇標別</option>";
        return;
      }

      const emailListUrl = `${webAppUrl}?company=${company}`;
      emailSelect.innerHTML = "<option value=''>載入中...</option>";
      fetch(emailListUrl)
        .then(response => response.json())
        .then(emailList => {
          emailSelect.innerHTML = "<option value=''>請選擇 Email</option>";
          emailList.forEach(email => {
            const option = document.createElement("option");
            option.value = email;
            option.textContent = email;
            emailSelect.appendChild(option);
          });
          statusDiv.textContent = "✅ Email 清單載入完成";
        })
        .catch(error => {
          console.error("載入 Email 清單失敗", error);
          statusDiv.textContent = "❌ 載入 Email 清單失敗";
        });
    });

    function getTodayKey(email) {
      const today = new Date().toISOString().slice(0, 10);
      return `${email}_${today}`;
    }

    function submitLocation() {
      const company = companySelect.value;
      const webAppUrl = getWebAppUrl(company);
      const email = emailSelect.value.trim();
      const action = document.getElementById("action").value;
      const button = document.getElementById("submitBtn");
      mapLink.innerHTML = "";

      if (!company || !webAppUrl) {
        statusDiv.textContent = "請先選擇公司。";
        return;
      }

      if (!email) {
        statusDiv.textContent = "請先選擇 Email。";
        return;
      }

      const todayKey = getTodayKey(email);
      if (action === "checkin" && localStorage.getItem(todayKey)) {
        statusDiv.textContent = "⚠️ 今日已簽到過，請勿重複簽到。";
        return;
      }

      button.disabled = true;
      spinner.style.display = "block";
      statusDiv.textContent = "正在取得定位資訊...";

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          position => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            mapLink.innerHTML = `<a href='https://www.google.com/maps?q=${lat},${lng}' target='_blank'>📍 查看地圖</a>`;
            statusDiv.textContent = `取得座標：(${lat}, ${lng})，正在送出...`;

            fetch(webAppUrl, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ company, email, action, lat, lng })
            })
            .then(response => response.text())
            .then(data => {
              statusDiv.textContent = `伺服器回應：${data}`;
              if (action === "checkin" && data.includes("✅ 簽到成功")) {
                localStorage.setItem(todayKey, "checked");
              } else if (action === "checkout" && data.includes("✅ 簽退成功")) {
                localStorage.removeItem(todayKey);
              }
              button.disabled = false;
              spinner.style.display = "none";
            })
            .catch(error => {
              statusDiv.textContent = `送出失敗：${error}`;
              button.disabled = false;
              spinner.style.display = "none";
            });
          },
          error => {
            statusDiv.textContent = "❌ 定位失敗，請開啟 GPS 並允許定位權限。";
            button.disabled = false;
            spinner.style.display = "none";
          }
        );
      } else {
        statusDiv.textContent = "您的裝置不支援定位功能。";
        button.disabled = false;
        spinner.style.display = "none";
      }
    }
  </script>
</body>
</html>
